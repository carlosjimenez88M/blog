---
title: "Redes Bayesianas"
output: html_document
mathjax: "true"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

El uso de Bayes en temas como Machine Learning , estadística y en aplicaciones de AI son impresionantes y es por ello que este tipo de corriente es fundamental para tener modelos optimos para el que - hacer bajo un foco de negocio o investigación. Puntualmente la corriente del [emprirical bayes](https://en.wikipedia.org/wiki/Empirical_Bayes_method) proporciona una versión de diseño de modelos más apropiados , gracias a los parámetros que define en el proceso inferencial.


## Conceptos previos

* ¿ En qué consiste la teoría Bayesiana ?

Una aproximación que me llama la atención es la siguiente :
    
    + Es la que estudia el verdadero estado de un objeto de estudio en grados de incertidumbre.
  
Otra definición que cala más con un concepto en el mundo real es   
    
    + Es el procedimiento matemático que permite actualizar las probabilidades de los eventos determinados por creencias previas.
    
Dicho lo anterior , los metódos bayesianos se caracterizan por no tener en cuenta las probabilidad como una frecuencia rígida, sino por permitirse mover las distribuciones de las frecuencias (previa  y posterior). Dicho lo anterior la estadística bayesiana tiene las siguientes particularidades:

    + Variación en los parámetros
    + Data flexible 
    + Probabilidad condicionada
    + Credibilidad en los intervalos 
    + Una probabilidad prior (fuerte)
    
Dicho lo anterior , la probabilidad bayesiana tiene el siguiente comportamiento


$$
P(A|B) = \frac{P(B|A) P(A)}{P(B)}
$$

Donde:

i) P(A) = Probabilidad a priori

ii) P(B|A) = Probabilidad de B dada la hipótesis de A

iii) P(A|B) = Probabilidad posterior








Esta formula es indudablemente revolucionaria , por su sencillez y gran capacidad de aplicación. La [teoría bayesiana](https://towardsdatascience.com/bayes-theorem-the-holy-grail-of-data-science-55d93315defb), expresa la probabilidad condicionanda de un evento aleatorio gracias a la probabilidad de las distribuciones de los eventos.


## Redes Bayesianas 

Las redes bayesianas son el conjunto de grafos que representan un conjunto de variables random y sus condiciones. Un ejemplo sería : relaciones probabilisticas entre condiciones macroeconómicas y  crisis económicas.


Otra definición que puede ayudar a interpretar este concepto es la siguiente 

>"Bayesian networks (BNs) are a type of graphical model that encode the conditional probability between different learning variables in a directed acyclic graph." Hamed,(2019)


Dicho lo anterior cuando se desarrollan BNs (Bayesian Networks ) estamos hablando de una técnica del [ML no supervisado ](https://towardsdatascience.com/unsupervised-machine-learning-9329c97d6d9f), la cual es eficiente en el sentido de encontrar estadísticos robustos.


Un ejemplo sería el siguiente (la data está incluida en el paquete [bnlearn](http://www.bnlearn.com/)). "Coronary" es un set de tatos que describe los facortes de riesgo para una trombosis coronaria.

La estructura de los datos es la siguiente 

* Smoking : Si fuma o no !
* Strenuous mental work : Si el trabajo es estresante mentalmenter
* Strenuous physical work: Si el trabajo exige algún nivel de estrés fisico.
* Pressure: Presión {<140,140>}
* Proteins : Radio de beta o alfa lipoproteinas.
* Family : Antecedentes familiares de enfermedades coronarias.


## Un poco de análisis exploratorio




```{r, echo=FALSE, cache=FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(bnlearn)
library(visNetwork)
library(gridExtra)
library(knitr)
library(kableExtra)
data("coronary")
```


La distribución de las observaciones sobre los que fuman o no es la siguiente

```{r, echo=FALSE, cache=FALSE}
coronary%>%
  mutate(Smoking=as.factor(Smoking))%>%
  group_by(Smoking)%>%
  summarize(Total=n())%>%
  mutate(perc=round((Total/sum(Total))*100,2))%>%
  ggplot(aes(Smoking,Total,fill=Smoking))+
  geom_bar(stat = 'identity')+
  geom_text(aes(label=paste(perc,"%")),position = position_stack(vjust = .5))+
  labs(title = 'Proporción entre los fumadores activos y no')
```



La Diferencia es mínima entre los fumadores y los no , por lo cual computare una estadística que determine el comportamiento promedio entre si es fumador o no y los efectos sobre  su presión.


```{r, echo=FALSE, cache=FALSE}
library(knitr)
coronary%>%
  group_by(Smoking,Pressure)%>%
  summarize(Total=n())%>%
  group_by(Smoking)%>%
  mutate(perc=round(Total/sum(Total)*100,2))%>%
  kable(format = 'markdown', caption = 'Relación entre actividad fumadora y la presión')

```

La proporción indica que los fumadores tienden a tener la presión más baja.


Ahora estudiaré está relación en una comparación con los antecedentes familiares , el estrés laboral y el estrés fisico
```{r, echo=FALSE, cache=FALSE}
library(scales)
p1 <- coronary %>%
    ggplot(aes(x = Smoking,y = (..count..)/sum(..count..), fill = Family)) + geom_bar(position = "fill") + 
    scale_y_continuous(labels = percent) + 
    labs(title = "Percentage of People Smoking by family antecedents",
         y = "Percentage [%]",
         x = "")

p2 <- coronary %>%
    ggplot(aes(x = Smoking,y = (..count..)/sum(..count..), fill = `M. Work`)) + geom_bar(position = "fill") + 
    scale_y_continuous(labels = percent) + 
    labs(title = "Percentage of People Smoking by trenuous mental work",
         y = "Percentage [%]",
         x = "")
p3 <- coronary %>%
    ggplot(aes(x = Smoking,y = (..count..)/sum(..count..), fill = `P. Work`)) + geom_bar(position = "fill") + 
    scale_y_continuous(labels = percent) + 
    labs(title = "Percentage of People Smoking by strenuous physical work ",
         y = "Percentage [%]",
         x = "")

grid.arrange(p1,p2,p3,nrow = 1)
```

Primeras conclusiones :

* Tiende a fumarse un poco más cuando hay antecedentes familiares, más al diferencia no es relevante;

* Se fuma menos cuando hay estrés mental laboral;

* Se fuma más cuando hay evidencia de estrés fisico.

Quedo con una duda, y es si realmente hay una diferencia o no cuando los individuos tienen antecedentes familiares, por lo cual desarrolllo una prueba de inferencia y los resultados son los siguientes 

```{r, echo=FALSE, cache=FALSE}
# H0: No hay diferencia entre los fumadores y los no fumadores dado los antecendentes familiares

# H1: Hay una diferenciua entre los fumadores y los no fumadores dado sus antecedentes familiares

coronary%>%
  ggplot(aes(x=Smoking,fill=Family))+
  geom_bar()
  
```

```{r, echo=FALSE, cache=FALSE}
coronary%>%
  group_by(Smoking,Family,Pressure)%>%
  summarize(Total=n())->MN

MN%>%
  group_by(Family,Pressure)%>%
  summarize(mean=mean(Total), sd=sd(Total), n=n())->dat


computeSE <- function(dat){
    sd <- dat$sd
    n <- dat$n
    tmp <- sqrt(sd[1]/n[1] + sd[2]/n[2])
    return(tmp)
}
se_lessthan140 <- dat %>%
    filter(Pressure =='<140') %>%
    computeSE()
se_morethan <- dat %>%
    filter(Pressure =='>140') %>%
    computeSE()


computeTStat <- function(dat){
    mu <- dat$mean
    tmp <- (mu[1]-mu[2])/computeSE(dat)
    return(abs(tmp))
}

tstat_lessthan140 <- dat %>%
    filter(Pressure == '<140') %>%
    computeTStat()
tstat_morethan140 <- dat %>%
    filter(Pressure == '>140') %>%
    computeTStat()

dt <- data.frame(tstat_lessthan140,tstat_morethan140)
kable(dt, "html") %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

Se calculan los P valores

```{r, echo=FALSE, cache=FALSE}
computeDOF <- function(dat){
    n <- dat$n
    return(min(n)-1)
}
dof_neg140 <- dat %>%
    filter(Pressure == '<140') %>%
    computeDOF()
dof_pos140 <- dat %>%
    filter(Pressure == '>140') %>%
    computeDOF()

pval_neg140 <- pt(tstat_lessthan140, dof_neg140, lower.tail = F)*2
pval_pos140 <- pt(tstat_morethan140, dof_pos140, lower.tail = F)*2

dt <- data.frame(pval_neg140,pval_pos140)
kable(dt, "html") %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

La evidencia muestra que no hay evidencia para decir que las personas fuman o no desde los antecedentes familiares.


## Creando la Red Bayesiana 


Lo primero es crear la red , la cual determinará la dependencia entre variables


```{r, echo=FALSE, cache=FALSE}
coronary<-data.frame(coronary)
hc(coronary)%>%
  plot()
```


El ejericio que intente describir en el paso anterior (exceptuando la parte de inferencia), se puede resumir con la construcción de la red, lo importante de esto es lo que al principio del post argumentaba **estudiar la relación probabilistica entre variables aleatorias**.


Lo que se puede observar de antemano es que hay algunas relaciones que no tienen sentido practico, por lo cual se elimina la relación entre familia con antecedentes y el estrés mental.


```{r, echo=FALSE, cache=FALSE}
res <- hc(data.frame(coronary))
res$arcs<-res$arcs[-which((res$arcs[,'from'] == "M..Work" & res$arcs[,'to'] == "Family")),]
plot(res)
```

Ahora se calculan las probabilidades condicionales 

```{r, echo=FALSE, cache=FALSE}
fittedbn <- bn.fit(res, data = data.frame(coronary))
print(fittedbn$Proteins)
```


Se desarrolla un ejercicio de inferencia para determinar de manera correcta los parámetros de está red y los resultados son los siguientes

Protenias presenta una relación con dos variables, pero el sentido practico indica que debe ser por una, en la inferencia se intenta probar que el efecto de que sea menor a tres se debe al hecho de no fumar. El resultado es el siguiente
```{r, echo=FALSE, cache=FALSE}
cpquery(fittedbn, event = (Proteins=="<3"), evidence = ( Smoking=="no") )
```


Pero si se intenta determinar que el efecto de la proteina sea debido a que no fume , cuál es la probabilidad de que sea un no fumador y tener una presión mayor a 140?
```{r, echo=FALSE, cache=FALSE}
cpquery(fittedbn, event = (Proteins=="<3"), evidence = ( Smoking=="no" & Pressure==">140" ) )
```

La probabilidad es del 65%





## Simulación de datos 

El proceso de simulación se desarrolla a través de muestreo de cada uno de los nodos raíz,  está técnica con las redes Bayesianas, dada la actualización del conocimiento permite que los estadísticos más robustos sean lo más fieles o similares a la data original. Esta técnica es fundamental para el desarrollo de modelos de ML , puntualmente para equilibrar la data o generar sets de entrenamiento.

```{r, echo=FALSE, cache=FALSE}
plot.network <- function(structure, ht = "400px", cols = "darkturquoise", labels = nodes(structure)){
  if(is.null(labels)) labels <- rep("", length(nodes(structure)))
  nodes <- data.frame(id = nodes(structure),
                      label = labels,
                      color = cols,
                      shadow = TRUE
                      )

  edges <- data.frame(from = structure$arcs[,1],
                      to = structure$arcs[,2],
                      arrows = "to",
                      smooth = FALSE,
                      shadow = TRUE,
                      color = "black")

  return(visNetwork(nodes, edges, height = ht, width = "100%"))
}

```


```{r, echo=FALSE, cache=FALSE}
attach(coronary)
bn_str<-model2network(modelstring(res))
plot.network(bn_str)
```

A través de la simulación bayesiana dada las de pendencias y probabilidad de las ocurrencias se obtiene el siguiente resultado

```{r, echo=FALSE, cache=FALSE}
coronary_sim<-rbn(fittedbn, 1841)

coronary_sim%>%
  head()%>%
  kable(format = 'markdown',caption = 'Data Simulada')
```


Se compara la data simulada con respecto a la original

```{r, echo=FALSE,cache=FALSE}
coronary%>%
  group_by(Smoking)%>%
  summarize(Total=n())%>%
  ggplot(aes(Smoking,Total))+
  geom_bar(stat = 'identity')+
  labs(title = 'Original Data by Smoking')->uno


dos<-coronary_sim%>%
  group_by(Smoking)%>%
  summarize(Total=n())%>%
  ggplot(aes(Smoking,Total))+
  geom_bar(stat = 'identity')+
  labs(title = 'Simmulated Data by Smoking')

grid.arrange(uno,dos,ncol=2)
```

```{r, echo=FALSE, cache=FALSE}
coronary%>%
  group_by(M..Work,Pressure)%>%
  summarize(Total=n())%>%
  ggplot(aes(M..Work,Total,fill=Pressure))+
  geom_bar(stat = 'identity')+
  labs(title = 'Original Data by M..Work')->uno


dos<-coronary_sim%>%
  group_by(M..Work,Pressure)%>%
  summarize(Total=n())%>%
  ggplot(aes(M..Work,Total, fill=Pressure))+
  geom_bar(stat = 'identity')+
  labs(title = 'Simmulated Data by M..Work')

grid.arrange(uno,dos,ncol=2)
```



##  Generar un modelo en cada caso

Se generan modelos modelos lineales generalizados para evaluar cada uno de los estadísticos y compararlos entre la data simulada y la original.

```{r, echo=FALSE, cache=FALSE}
glm(Pressure~., data = coronary,family = binomial(link = "logit"))
```

Para la data simulada

```{r}
glm(Pressure~., data = coronary_sim,family = binomial(link = "logit"))
```

La conclusión es que los estadísticos son bastante similares, por lo cual la simulación cumplio el fin buscado!






